name: Integration Tests
run-name: AWS Advanced ODBC Wrapper Integration Tests - ${{ github.event.head_commit.message }}

on:
  workflow_dispatch:
  push:
    branches:
      - main
  pull_request:
    branches:
      - '**'
    paths-ignore:
      - '**/*.md'
      - '**/*.jpg'
      - '**/*.png'
      - '**/README.*'
      - '**/LICENSE.*'
      - 'docs/**'
      - 'ISSUE_TEMPLATE/**'

env:
  BUILD_CONFIG: Release
  WIX_VERSION: 5.0.2

  # Test configuration
  TEST_DATABASE: 'test_database'
  ENGINE_VERSION: 'latest'
  NUM_INSTANCES: '5'

  # Limitless
  TEST_LIMITLESS_DATABASE: 'postgres_limitless'
  ENGINE_LIMITLESS_VERSION: 'latest'

  TEST_DSN_ANSI: 'AWS-ODBC-ANSI'
  TEST_DSN_UNICODE: 'AWS-ODBC-UNICODE'
  DRIVER_NAME_ANSI: 'AWS Advanced ODBC Wrapper Ansi'
  DRIVER_NAME_UNICODE: 'AWS Advanced ODBC Wrapper Unicode'

concurrency:
  group: integration-test-${{ github.ref }}
  cancel-in-progress: false

permissions:
  id-token: write
  contents: read

jobs:
# Build / Get Underlying Drivers
  build-win-psqlodbc:
    name: Windows - Build psqlODBC
    runs-on: windows-latest
    steps:
      - name: Retrieve psqlODBC Cache
        id: cache-psqlodbc
        uses: actions/cache@v4
        with:
          path: psqlodbc
          key: ${{ runner.os }}-psqlodbc-driver
      - name: Download psqlODBC
        if: ${{steps.cache-psqlodbc.outputs.cache-hit != 'true'}}
        run: |
          mkdir psqlodbc
          cd psqlodbc
          $DOWNLOAD_URL=$(gh api repos/postgresql-interfaces/psqlodbc/releases --jq '.[0].assets.[] | select(.name=="psqlodbc_x64.msi") | .browser_download_url')
          curl.exe -L ${DOWNLOAD_URL} --output psqlodbc_x64.msi
        env:
          GH_TOKEN: ${{ github.token }}

  build-macos-psqlodbc:
    name: MacOS - Build psqlODBC
    if: github.event_name == 'workflow_dispatch'
    runs-on: macos-15
    steps:
      - name: Retrieve psqlODBC Cache
        id: cache-psqlodbc
        uses: actions/cache@v4
        with:
          path: psqlodbc/.libs/
          key: ${{ runner.os }}-psqlodbc-driver
      - name: Checkout psqlODBC
        if: ${{steps.cache-psqlodbc.outputs.cache-hit != 'true'}}
        uses: actions/checkout@v4
        with:
          repository: postgresql-interfaces/psqlodbc
          path: psqlodbc
      - name: Install Dependencies
        if: ${{steps.cache-psqlodbc.outputs.cache-hit != 'true'}}
        run: |
          brew update && brew upgrade && brew cleanup
          brew install gcc autoconf automake unixodbc libtool postgresql
      - name: Build psqlodbc
        if: ${{steps.cache-psqlodbc.outputs.cache-hit != 'true'}}
        working-directory: psqlodbc
        run: |
          ./bootstrap
          ./configure
          make

  build-linux-psqlodbc:
    name: Linux Ubuntu - Build psqlODBC
    runs-on: ubuntu-latest
    steps:
      - name: Retrieve psqlODBC Cache
        id: cache-psqlodbc
        uses: actions/cache@v4
        with:
          path: psqlodbc/.libs/
          key: ${{ runner.os }}-psqlodbc-driver
      - name: Checkout psqlODBC
        if: ${{steps.cache-psqlodbc.outputs.cache-hit != 'true'}}
        uses: actions/checkout@v4
        with:
          repository: postgresql-interfaces/psqlodbc
          path: psqlodbc
      - name: Install Dependencies
        if: ${{steps.cache-psqlodbc.outputs.cache-hit != 'true'}}
        run: |
          sudo apt update
          sudo apt-get install autoconf automake libtool postgresql libpq-dev
      - name: Download & Build unixODBC
        if: ${{steps.cache-psqlodbc.outputs.cache-hit != 'true'}}
        run: |
          curl -L https://www.unixodbc.org/unixODBC-2.3.12.tar.gz -o unixODBC.tar
          tar xf unixODBC.tar
          cd unixODBC-2.3.12
          ./configure && make
          sudo make install
      - name: Build psqlodbc
        if: ${{steps.cache-psqlodbc.outputs.cache-hit != 'true'}}
        working-directory: psqlodbc
        run: |
          ./bootstrap
          ./configure
          make

  build-win-mysql:
    name: Windows - Build MySQL Connector ODBC
    runs-on: windows-latest
    steps:
      - name: Retrieve mysql-connector Cache
        id: cache-mysql-connector
        uses: actions/cache@v4
        with:
          path: mysql-connector
          key: ${{ runner.os }}-mysql-driver
      - name: Download mysql-connector
        if: ${{steps.cache-mysql-connector.outputs.cache-hit != 'true'}}
        run: |
          mkdir mysql-connector
          cd mysql-connector
          curl.exe -L "https://dev.mysql.com/get/Downloads/Connector-ODBC/9.5/mysql-connector-odbc-9.5.0-winx64.msi" --output mysql-connector_x64.msi

  build-macos-mysql:
    name: MacOS - Build MySQL Connector ODBC
    if: github.event_name == 'workflow_dispatch'
    runs-on: macos-15
    steps:
      - name: Retrieve mysql-connector Cache
        id: cache-mysql-connector
        uses: actions/cache@v4
        with:
          path: mysql-connector/
          key: ${{ runner.os }}-mysql-driver
      - name: Download mysql-connector
        if: ${{steps.cache-mysql-connector.outputs.cache-hit != 'true'}}
        run: |
          mkdir mysql-connector
          curl -L "https://dev.mysql.com/get/Downloads/Connector-ODBC/9.5/mysql-connector-odbc-9.5.0-macos15-arm64.tar.gz" --output mysql-connector_arm64.tar.gz
          tar xvf mysql-connector_arm64.tar.gz --strip-components 1 -C mysql-connector

  build-linux-mysql:
    name: Linux Ubuntu - Build MySQL Connector ODBC
    runs-on: ubuntu-latest
    steps:
      - name: Retrieve mysql-connector Cache
        id: cache-mysql-connector
        uses: actions/cache@v4
        with:
          path: mysql-connector/
          key: ${{ runner.os }}-mysql-driver
      - name: Download mysql-connector
        if: ${{steps.cache-mysql-connector.outputs.cache-hit != 'true'}}
        run: |
          mkdir mysql-connector
          cd mysql-connector
          curl \
            -L "https://dev.mysql.com/get/Downloads/Connector-ODBC/9.5/mysql-connector-odbc_9.5.0-1ubuntu24.04_amd64.deb" \
            --output mysql-connector_x64.deb

# Build Wrapper & Run Tests
  windows-integration-tests:
    name: Windows - Integration Tests
    needs: [build-win-psqlodbc, build-win-mysql]
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        rds_engine: [aurora-postgresql, aurora-mysql]
    steps:
      - name: Setup Cluster ID
        run: |
          echo "AURORA_CLUSTER_ID=ODBC-Win-${{matrix.rds_engine}}-${{github.run_id}}${{github.run_number}}${{github.run_attempt}}" | Out-File -FilePath $env:GITHUB_ENV -Append
      - name: Setup Custom Endpoint ID
        run: |
          echo "CUSTOM_ENDPOINT_ID=CUSTOM-ENDPOINT-${{env.AURORA_CLUSTER_ID}}" | Out-File -FilePath $env:GITHUB_ENV -Append
      - name: Checkout aws-advanced-odbc-wrapper
        uses: actions/checkout@v4
      - name: Retrieve AWS SDK for C++ Cache
        id: cache-aws-sdk
        uses: actions/cache@v4
        with:
          path: aws_sdk/install
          key: ${{ runner.os }}-aws-sdk-cpp-${{env.BUILD_CONFIG}}-shared
      - name: Build AWS SDK for C++
        if: ${{steps.cache-aws-sdk.outputs.cache-hit != 'true'}}
        run: |
          ./scripts/compile_aws_sdk_win.ps1 ${{env.BUILD_CONFIG}}
      - name: Setup Dotnet for WiX
        uses: actions/setup-dotnet@v4
      - name: Install WiX
        shell: cmd
        run: |
          dotnet tool install --global wix --version ${{env.WIX_VERSION}}
          wix extension add --global WixToolset.UI.wixext/${{env.WIX_VERSION}}
      - name: Run build installer script
        shell: pwsh
        run: |
          ./installer/build_installer.ps1 ${{env.BUILD_CONFIG}}
      - name: Install driver
        shell: pwsh
        working-directory: installer
        run: Start-Process msiexec "/lp! .\test.log /i aws-advanced-odbc-wrapper.msi /quiet /norestart" -Wait;
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ secrets.AWS_DEFAULT_REGION }}
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/${{ secrets.AWS_DEPLOY_ROLE }}
          role-session-name: odbc-wrapper-win-inte
      - name: Create RDS Cluster
        id: AuroraClusterSetup
        shell: pwsh
        working-directory: ./scripts
        run: |
          . ".\aws_rds_helper_win.ps1"
          Create-Aurora-RDS-Cluster `
            -TestUsername ${{ secrets.TEST_USERNAME }} `
            -TestPassword ${{ secrets.TEST_PASSWORD }} `
            -TestDatabase ${{ env.TEST_DATABASE }} `
            -ClusterId ${{ env.AURORA_CLUSTER_ID }} `
            -NumInstances ${{ env.NUM_INSTANCES }}  `
            -Engine ${{matrix.rds_engine}} `
            -EngineVersion ${{ env.ENGINE_VERSION }} `
            -Region ${{ secrets.AWS_DEFAULT_REGION }}
      - name: Create RDS Custom Endpoint
        id: AuroraCustomEndpointSetup
        shell: pwsh
        working-directory: ./scripts
        run: |
          . ".\aws_rds_helper_win.ps1"
          Create-Custom-Endpoint `
            -EndpointName ${{ env.CUSTOM_ENDPOINT_ID }} `
            -ClusterId ${{ env.AURORA_CLUSTER_ID }} `
            -NumInstances ${{ env.NUM_INSTANCES }} `
            -StaticList
      - name: Get Aurora Cluster endpoint
        shell: pwsh
        working-directory: ./scripts
        run: |
          . ".\aws_rds_helper_win.ps1"
          $endpoint = (Get-Cluster-Endpoint -ClusterId ${{ env.AURORA_CLUSTER_ID }})
          echo "AURORA_CLUSTER_ENDPOINT=$endpoint" | Out-File -FilePath $env:GITHUB_ENV -Append
      - name: Create Aurora Cluster Secrets
        shell: pwsh
        working-directory: ./scripts
        run: |
            . ".\aws_rds_helper_win.ps1"
            $secrets = (Create-Db-Secrets `
              -Username ${{ secrets.TEST_USERNAME }} `
              -Password ${{ secrets.TEST_PASSWORD }} `
              -Engine "${{matrix.rds_engine}}" `
              -ClusterEndpoint ${{ env.AURORA_CLUSTER_ENDPOINT }})
            echo "::add-mask::$secrets"
            echo "AURORA_CLUSTER_SECRETS_ARN=$secrets" | Out-File -FilePath $env:GITHUB_ENV -Append
      - name: Setup Base Driver Variables
        id: base_driver_info
        shell: bash
        run: |
          if [ "${{ matrix.rds_engine }}" == "aurora-postgresql" ]; then
            echo "cache_path=psqlodbc" >> $GITHUB_OUTPUT
            echo "cache_key=${{ runner.os }}-psqlodbc-driver" >> $GITHUB_OUTPUT
            echo "driver_path_ansi=C:\\Program Files\\psqlODBC\\1700\\bin\\podbc30a.dll" >> $GITHUB_OUTPUT
            echo "driver_path_unicode=C:\\Program Files\\psqlODBC\\1700\\bin\\podbc35w.dll" >> $GITHUB_OUTPUT
            echo "dialect_default_port=5432" >> $GITHUB_OUTPUT
            echo "database_dialect=AURORA_POSTGRESQL" >> $GITHUB_OUTPUT
          elif [ "${{ matrix.rds_engine }}" == "aurora-mysql" ]; then
            echo "cache_path=mysql-connector" >> $GITHUB_OUTPUT
            echo "cache_key=${{ runner.os }}-mysql-driver" >> $GITHUB_OUTPUT
            echo "driver_path_ansi=C:\\Program Files\\MySQL\\MySQL Connector ODBC 9.5\\myodbc9a.dll" >> $GITHUB_OUTPUT
            echo "driver_path_unicode=C:\\Program Files\\MySQL\\MySQL Connector ODBC 9.5\\myodbc9w.dll" >> $GITHUB_OUTPUT
            echo "dialect_default_port=3306" >> $GITHUB_OUTPUT
            echo "database_dialect=AURORA_MYSQL" >> $GITHUB_OUTPUT
          fi
      - name: Retrieve Base Driver
        uses: actions/cache@v4
        with:
          path: ${{steps.base_driver_info.outputs.cache_path}}
          key: ${{steps.base_driver_info.outputs.cache_key}}
          fail-on-cache-miss: true
      - name: Install PostgreSQL
        if: (matrix.rds_engine == 'aurora-postgresql')
        shell: pwsh
        working-directory: ${{steps.base_driver_info.outputs.cache_path}}
        run: |
          Start-Process msiexec "/i psqlodbc_x64.msi /quiet /norestart" -Wait;
      - name: Setup PostgreSQL
        if: (matrix.rds_engine == 'aurora-postgresql')
        shell: bash
        run: |
          echo "$PGBIN" >> $GITHUB_PATH
      - name: Setup PostgreSQL User
        if: (matrix.rds_engine == 'aurora-postgresql')
        shell: bash
        run: |
          psql postgresql://${{ secrets.TEST_USERNAME }}:${{ secrets.TEST_PASSWORD }}@${{env.AURORA_CLUSTER_ENDPOINT}}:${{steps.base_driver_info.outputs.dialect_default_port}}/${{ env.TEST_DATABASE }} \
            --command="CREATE USER ${{ secrets.TEST_IAM_USER }};" \
            --command="GRANT rds_iam TO ${{ secrets.TEST_IAM_USER }};" \
            --command="\du"
      - name: Install MySQL
        if: (matrix.rds_engine == 'aurora-mysql')
        shell: pwsh
        working-directory: ${{steps.base_driver_info.outputs.cache_path}}
        run: |
          Start-Process msiexec "/i mysql-connector_x64.msi /quiet /norestart" -Wait;
      - name: Setup MySQL User
        if: (matrix.rds_engine == 'aurora-mysql')
        shell: bash
        working-directory: ${{steps.base_driver_info.outputs.cache_path}}
        run: |
          mysql -h ${{ env.AURORA_CLUSTER_ENDPOINT }} -P 3306 -D ${{ env.TEST_DATABASE }} -u ${{ secrets.TEST_USERNAME }} -p${{ secrets.TEST_PASSWORD }} --execute="CREATE USER '${{ secrets.TEST_IAM_USER }}' IDENTIFIED WITH AWSAuthenticationPlugin AS 'RDS'; GRANT ALL on ${{ env.TEST_DATABASE }}.* TO '${{ secrets.TEST_IAM_USER }}'@'%'; FLUSH PRIVILEGES;"
      - name: Install Ansi DSNs
        shell: pwsh
        run: |
            Add-OdbcDsn -Name ${{ env.TEST_DSN_ANSI }} `
              -DriverName "${{ env.DRIVER_NAME_ANSI }}" `
              -DsnType User `
              -SetPropertyValue `
              @("RDS_AUTH_TYPE=database", `
              "Server=${{ env.AURORA_CLUSTER_ENDPOINT }}", `
              "Port=${{steps.base_driver_info.outputs.dialect_default_port}}", `
              "SSLMode=prefer", `
              "BASE_DRIVER=${{steps.base_driver_info.outputs.driver_path_ansi}}")
      - name: Install Unicode DSNs
        shell: pwsh
        run: |
            Add-OdbcDsn -Name ${{ env.TEST_DSN_UNICODE }} `
              -DriverName "${{ env.DRIVER_NAME_UNICODE }}" `
              -DsnType User `
              -SetPropertyValue `
              @("RDS_AUTH_TYPE=database", `
              "Server=${{ env.AURORA_CLUSTER_ENDPOINT }}", `
              "Port=${{steps.base_driver_info.outputs.dialect_default_port}}", `
              "SSLMode=prefer", `
              "BASE_DRIVER=${{steps.base_driver_info.outputs.driver_path_unicode}}")
      - name: Create logs folder
        run: mkdir logs
      - name: Build and Run Ansi Integration Tests
        shell: pwsh
        if: ${{steps.AuroraClusterSetup.outcome == 'success'}}
        run: |
          cmake -S test/integration -B build_ansi -D CMAKE_BUILD_TYPE="${{env.BUILD_CONFIG}}" `
            -D BUILD_UNICODE=OFF -D BUILD_FAILOVER=ON -D BUILD_LIMITLESS=OFF
          cmake --build build_ansi --config ${{env.BUILD_CONFIG}}
          echo "Ansi Test Built"
          .\build_ansi\${{env.BUILD_CONFIG}}\integration-test.exe
        env:
          TEST_DSN: ${{ env.TEST_DSN_ANSI }}
          TEST_DATABASE: ${{ env.TEST_DATABASE }}
          TEST_USERNAME: ${{ secrets.TEST_USERNAME }}
          TEST_PASSWORD: ${{ secrets.TEST_PASSWORD }}
          TEST_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
          TEST_IAM_USER: ${{ secrets.TEST_IAM_USER }}
          TEST_SECRET_ARN: ${{ env.AURORA_CLUSTER_SECRETS_ARN }}
          TEST_SERVER: ${{ env.AURORA_CLUSTER_ENDPOINT }}
          TEST_PORT: ${{steps.base_driver_info.outputs.dialect_default_port}}
          TEST_DIALECT: "${{ steps.base_driver_info.outputs.database_dialect }}"
          TEST_CUSTOM_ENDPOINT_ID: "${{ env.CUSTOM_ENDPOINT_ID }}"
      - name: Build and Run Unicode Integration Tests
        shell: pwsh
        if: ${{steps.AuroraClusterSetup.outcome == 'success'}}
        run: |
          cmake -S test/integration -B build_unicode -D CMAKE_BUILD_TYPE=${{env.BUILD_CONFIG}} `
            -D BUILD_UNICODE=ON -D BUILD_FAILOVER=ON -D BUILD_LIMITLESS=OFF
          cmake --build build_unicode --config ${{env.BUILD_CONFIG}}
          echo "Unicode Test Built"
          .\build_unicode\${{env.BUILD_CONFIG}}\integration-test.exe
        env:
          TEST_DSN: ${{ env.TEST_DSN_UNICODE }}
          TEST_DATABASE: ${{ env.TEST_DATABASE }}
          TEST_USERNAME: ${{ secrets.TEST_USERNAME }}
          TEST_PASSWORD: ${{ secrets.TEST_PASSWORD }}
          TEST_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
          TEST_IAM_USER: ${{ secrets.TEST_IAM_USER }}
          TEST_SECRET_ARN: ${{ env.AURORA_CLUSTER_SECRETS_ARN }}
          TEST_SERVER: ${{ env.AURORA_CLUSTER_ENDPOINT }}
          TEST_PORT: ${{steps.base_driver_info.outputs.dialect_default_port}}
          TEST_DIALECT: "${{ steps.base_driver_info.outputs.database_dialect }}"
          TEST_CUSTOM_ENDPOINT_ID: "${{ env.CUSTOM_ENDPOINT_ID }}"
      - name: Delete RDS Custom Endpoint
        if: always()
        shell: pwsh
        working-directory: ./scripts
        run: |
          . ".\aws_rds_helper_win.ps1"
          Delete-Custom-Endpoint -EndpointName ${{ env.CUSTOM_ENDPOINT_ID }} -ClusterId ${{ env.AURORA_CLUSTER_ID }}
      - name: Delete Aurora RDS Cluster
        if: always()
        shell: pwsh
        working-directory: ./scripts
        run: |
          . ".\aws_rds_helper_win.ps1"
          Delete-Aurora-Db-Cluster -ClusterId ${{ env.AURORA_CLUSTER_ID }} -Region ${{ secrets.AWS_DEFAULT_REGION }} -NumInstances 5
      - name: Delete Aurora Db Secrets
        if: always()
        shell: pwsh
        working-directory: ./scripts
        run: |
          . ".\aws_rds_helper_win.ps1"
          Delete-Secrets ${{ env.AURORA_CLUSTER_SECRETS_ARN }}
      # Make sure IP is always deleted
      - name: Get Github Action IP
        if: always()
        id: ip
        uses: haythem/public-ip@v1.3
      - name: Remove Github Action IP
        if: always()
        run: |
          aws ec2 revoke-security-group-ingress `
            --group-name default `
            --protocol tcp `
            --port 0-65535 `
            --cidr ${{ steps.ip.outputs.ipv4 }}/32 `
           *> $null;
      # - name: Copy Driver Logs
      #   shell: pwsh
      #   run: |
      #     Copy-Item -Path '${{ runner.temp }}/aws-odbc-wrapper/*.log.*' -Destination '${{ github.workspace }}\logs'
      - name: Archive log results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: 'windows-${{matrix.rds_engine}}-test-logs'
          path: C:\Users\runneradmin\AppData\Local\Temp\aws-odbc-wrapper\
          retention-days: 3
      - name: Archive psql logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: 'windows-${{matrix.rds_engine}}-psql-logs'
          path: logs
          retention-days: 3

  macos-integration-tests:
    name: MacOS - Integration Tests
    if: github.event_name == 'workflow_dispatch'
    needs: [build-macos-psqlodbc, build-macos-mysql]
    runs-on: macos-15
    strategy:
      fail-fast: false
      matrix:
        rds_engine: [aurora-postgresql, aurora-mysql]
    steps:
      - name: Setup Cluster ID
        run: |
          echo "AURORA_CLUSTER_ID=ODBC-MacOS-${{matrix.rds_engine}}-${{github.run_id}}${{github.run_number}}${{github.run_attempt}}" >> $GITHUB_ENV
      - name: Setup Custom Endpoint ID
        run: |
          echo "CUSTOM_ENDPOINT_ID=CUSTOM-ENDPOINT-${{env.AURORA_CLUSTER_ID}}" >> $GITHUB_ENV
      - name: Checkout aws-advanced-odbc-wrapper
        uses: actions/checkout@v4
      - name: Install Build Dependencies
        run: |
          brew update && brew upgrade && brew cleanup
          brew install cmake unixodbc postgresql curl openssl zlib icu4c
      - name: Retrieve AWS SDK for C++ Cache
        id: cache-aws-sdk
        uses: actions/cache@v4
        with:
          path: aws_sdk/install
          key: ${{ runner.os }}-aws-sdk-cpp-${{env.BUILD_CONFIG}}-shared
      - name: Build AWS SDK for C++
        if: ${{steps.cache-aws-sdk.outputs.cache-hit != 'true'}}
        run: |
          export SDKROOT="$(xcrun --sdk macosx --show-sdk-path)"
          ./scripts/compile_aws_sdk_unix.sh ${{env.BUILD_CONFIG}}
      - name: Build aws-advanced-odbc-wrapper
        run: |
          cmake -S . -B build -DBUILD_UNICODE=ON -DBUILD_ANSI=ON -DBUILD_UNIT_TEST=OFF -DCMAKE_BUILD_TYPE=${{env.BUILD_CONFIG}}
          cmake --build build
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ secrets.AWS_DEFAULT_REGION }}
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/${{ secrets.AWS_DEPLOY_ROLE }}
          role-session-name: odbc-wrapper-macos-inte
      - name: Create RDS Cluster
        id: AuroraClusterSetup
        shell: bash
        run: |
          . "./scripts/aws_rds_helper_unix.sh"
          create_aurora_rds_cluster \
            ${{ secrets.TEST_USERNAME }} \
            ${{ secrets.TEST_PASSWORD }} \
            ${{ env.TEST_DATABASE }} \
            ${{ env.AURORA_CLUSTER_ID }} \
            ${{ env.NUM_INSTANCES }} \
            ${{ matrix.rds_engine }} \
            ${{ env.ENGINE_VERSION }} \
            ${{ secrets.AWS_DEFAULT_REGION }}
      - name: Create RDS Custom Endpoint
        id: AuroraCustomEndpointSetup
        shell: bash
        run: |
          . "./scripts/aws_rds_helper_unix.sh"
          create_custom_endpoint \
            ${{ env.CUSTOM_ENDPOINT_ID }} \
            ${{ env.AURORA_CLUSTER_ID }} \
            ${{ env.NUM_INSTANCES }} \
            --static
      - name: Get Aurora Cluster endpoint
        shell: bash
        run: |
          . "./scripts/aws_rds_helper_unix.sh"
          endpoint=$(get_cluster_endpoint ${{ env.AURORA_CLUSTER_ID }})
          echo "AURORA_CLUSTER_ENDPOINT=$endpoint" >> $GITHUB_ENV
      - name: Create Aurora Cluster Secrets
        shell: bash
        run: |
            . "./scripts/aws_rds_helper_unix.sh"
            secretsArn=$(create_db_secrets \
                ${{ secrets.TEST_USERNAME }} \
                ${{ secrets.TEST_PASSWORD }} \
                ${{ matrix.rds_engine }} \
                ${{ env.AURORA_CLUSTER_ENDPOINT }})
            echo "::add-mask::$secretsArn"
            echo "AURORA_CLUSTER_SECRETS_ARN=$secretsArn" >> $GITHUB_ENV
      - name: Get Github Action IP
        if: always()
        id: ip
        run: |
          echo "ipv4=$(curl -s http://checkip.amazonaws.com)" >> $GITHUB_OUTPUT
      - name: Add IP to Allowlist
        run: |
          . "scripts/aws_rds_helper_unix.sh"
          add_ip_to_db_sg \
            ${{ steps.ip.outputs.ipv4 }} \
            ${{ env.AURORA_CLUSTER_ID }} \
            ${{ secrets.AWS_DEFAULT_REGION }}
      - name: Setup Base Driver Variables
        id: base_driver_info
        shell: bash
        run: |
          if [ "${{ matrix.rds_engine }}" == "aurora-postgresql" ]; then
            echo "cache_path=psqlodbc/.libs/" >> $GITHUB_OUTPUT
            echo "cache_key=${{ runner.os }}-psqlodbc-driver" >> $GITHUB_OUTPUT
            echo "driver_path_ansi='${{ github.workspace }}/psqlodbc/.libs/psqlodbca.so'" >> $GITHUB_OUTPUT
            echo "driver_path_unicode='${{ github.workspace }}/psqlodbc/.libs/psqlodbcw.so'" >> $GITHUB_OUTPUT
            echo "dialect_default_port=5432" >> $GITHUB_OUTPUT
            echo "database_dialect=AURORA_POSTGRESQL" >> $GITHUB_OUTPUT
          elif [ "${{ matrix.rds_engine }}" == "aurora-mysql" ]; then
            echo "cache_path=mysql-connector/" >> $GITHUB_OUTPUT
            echo "cache_key=${{ runner.os }}-mysql-driver" >> $GITHUB_OUTPUT
          echo "driver_path_ansi='${{ github.workspace }}/mysql-connector/lib/libmyodbc9a.so'" >> $GITHUB_OUTPUT
            echo "driver_path_unicode='${{ github.workspace }}/mysql-connector/lib/libmyodbc9w.so'" >> $GITHUB_OUTPUT
            echo "dialect_default_port=3306" >> $GITHUB_OUTPUT
            echo "database_dialect=AURORA_MYSQL" >> $GITHUB_OUTPUT
          fi
      - name: Retrieve Base Driver
        uses: actions/cache@v4
        with:
          path: ${{steps.base_driver_info.outputs.cache_path}}
          key: ${{steps.base_driver_info.outputs.cache_key}}
          fail-on-cache-miss: true
      - name: Setup PostgreSQL User
        if: (matrix.rds_engine == 'aurora-postgresql')
        shell: bash
        run: |
          brew install postgresql@16
          # --overwrite: Overwrite pre-installed GitHub Actions PostgreSQL binaries
          brew link --overwrite postgresql@16
          psql postgresql://${{ secrets.TEST_USERNAME }}:${{ secrets.TEST_PASSWORD }}@${{env.AURORA_CLUSTER_ENDPOINT}}:${{steps.base_driver_info.outputs.dialect_default_port}}/${{ env.TEST_DATABASE }} \
            --command="CREATE USER ${{ secrets.TEST_IAM_USER }};" \
            --command="GRANT rds_iam TO ${{ secrets.TEST_IAM_USER }};" \
            --command="\du"
      - name: Setup MySQL User
        if: (matrix.rds_engine == 'aurora-mysql')
        shell: bash
        working-directory: ${{steps.base_driver_info.outputs.cache_path}}
        run: |
          curl -L https://sourceforge.net/projects/iodbc/files/iodbc/3.52.16/iODBC-SDK-3.52.16-macOS11.dmg/download --output iodbc.dmg
          MOUNTDIR=$(echo `hdiutil mount iodbc.dmg | tail -1 \
          | awk '{$1=$2=""; print $0}'` | xargs -0 echo) \
          && sudo installer -pkg "${MOUNTDIR}/"*.pkg -target /
          brew install mysql
          mysql -h ${{ env.AURORA_CLUSTER_ENDPOINT }} -P 3306 -D ${{ env.TEST_DATABASE }} -u ${{ secrets.TEST_USERNAME }} -p${{ secrets.TEST_PASSWORD }} --execute="CREATE USER '${{ secrets.TEST_IAM_USER }}' IDENTIFIED WITH AWSAuthenticationPlugin AS 'RDS'; GRANT ALL on ${{ env.TEST_DATABASE }}.* TO '${{ secrets.TEST_IAM_USER }}'@'%'; FLUSH PRIVILEGES;"
      - name: Create logs folder
        run: mkdir logs
      - name: Build and Run Ansi Integration Tests
        shell: bash
        if: ${{ !cancelled() && steps.auroraClusterSetup.outcome == 'success'}}
        run: |
          cmake -S test/integration -B build_ansi \
            -D BUILD_UNICODE=OFF -D BUILD_FAILOVER=ON -D BUILD_LIMITLESS=OFF \
            -D CMAKE_BUILD_TYPE=${{env.BUILD_CONFIG}} \
            -D TEST_DRIVER_PATH="${{ github.workspace }}/build/driver/aws-advanced-odbc-wrapper-a.dylib" \
            -D BASE_DRIVER_PATH="${{steps.base_driver_info.outputs.driver_path_ansi}}" \
            -D TEST_SERVER="${{ env.AURORA_CLUSTER_ENDPOINT }}" \
            -D TEST_DATABASE="${{ env.TEST_DATABASE }}"
          cmake --build build_ansi
          echo "Ansi Test Built"
          ./build_ansi/integration-test
          cat ${{ github.workspace }}/test/resources/odbc.ini
          cat ${{ github.workspace }}/test/resources/odbcinst.ini
        env:
          TEST_DSN: "inte-wrapper-dsn"
          TEST_DATABASE: ${{ env.TEST_DATABASE }}
          TEST_USERNAME: ${{ secrets.TEST_USERNAME }}
          TEST_PASSWORD: ${{ secrets.TEST_PASSWORD }}
          TEST_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
          TEST_IAM_USER: ${{ secrets.TEST_IAM_USER }}
          TEST_SECRET_ARN: ${{ env.AURORA_CLUSTER_SECRETS_ARN }}
          TEST_SERVER: ${{ env.AURORA_CLUSTER_ENDPOINT }}
          TEST_PORT: "${{ steps.base_driver_info.outputs.dialect_default_port }}"
          TEST_DIALECT: "${{ steps.base_driver_info.outputs.database_dialect }}"
          ODBCINI: "${{ github.workspace }}/test/resources/odbc.ini"
          ODBCINST: "${{ github.workspace }}/test/resources/odbcinst.ini"
          TEST_CUSTOM_ENDPOINT_ID: "${{ env.CUSTOM_ENDPOINT_ID }}"
          # ASAN_OPTIONS: 'detect_container_overflow=0'
      - name: Build and Run Unicode Integration Tests
        shell: bash
        if: ${{steps.AuroraClusterSetup.outcome == 'success'}}
        run: |
          cmake -S test/integration -B build_unicode \
            -D BUILD_UNICODE=ON -D BUILD_FAILOVER=ON -D BUILD_LIMITLESS=OFF \
            -D CMAKE_BUILD_TYPE=${{env.BUILD_CONFIG}} \
            -D TEST_DRIVER_PATH="${{ github.workspace }}/build/driver/aws-advanced-odbc-wrapper-w.dylib" \
            -D BASE_DRIVER_PATH="${{steps.base_driver_info.outputs.driver_path_unicode}}" \
            -D TEST_SERVER="${{ env.AURORA_CLUSTER_ENDPOINT }}" \
            -D TEST_DATABASE="${{ env.TEST_DATABASE }}"
          cmake --build build_unicode
          echo "Unicode Test Built"
          cat ${{ github.workspace }}/test/resources/odbc.ini
          cat ${{ github.workspace }}/test/resources/odbcinst.ini
          ./build_unicode/integration-test
        env:
          TEST_DSN: "inte-wrapper-dsn"
          TEST_DATABASE: ${{ env.TEST_DATABASE }}
          TEST_USERNAME: ${{ secrets.TEST_USERNAME }}
          TEST_PASSWORD: ${{ secrets.TEST_PASSWORD }}
          TEST_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
          TEST_IAM_USER: ${{ secrets.TEST_IAM_USER }}
          TEST_SECRET_ARN: ${{ env.AURORA_CLUSTER_SECRETS_ARN }}
          TEST_SERVER: ${{ env.AURORA_CLUSTER_ENDPOINT }}
          TEST_PORT: "${{ steps.base_driver_info.outputs.dialect_default_port }}"
          TEST_DIALECT: "${{ steps.base_driver_info.outputs.database_dialect }}"
          ODBCINI: "${{ github.workspace }}/test/resources/odbc.ini"
          ODBCINST: "${{ github.workspace }}/test/resources/odbcinst.ini"
          TEST_CUSTOM_ENDPOINT_ID: "${{ env.CUSTOM_ENDPOINT_ID }}"
      - name: Get log location
        id: log_location
        run: echo "TEMP=$(echo $TMPDIR)" >> $GITHUB_OUTPUT
      - name: Delete RDS Custom Endpoint
        if: always()
        shell: bash
        run: |
          . "./scripts/aws_rds_helper_unix.sh"
          delete_custom_endpoint ${{ env.CUSTOM_ENDPOINT_ID }} ${{ env.AURORA_CLUSTER_ID }}
      - name: Delete Aurora RDS Cluster
        if: always()
        shell: bash
        run: |
          . "./scripts/aws_rds_helper_unix.sh"
          delete_aurora_db_cluster ${{ env.AURORA_CLUSTER_ID }} ${{ secrets.AWS_DEFAULT_REGION }} ${{ env.NUM_INSTANCES }}
      - name: Delete Aurora Db Secrets
        if: always()
        shell: bash
        run: |
          . "./scripts/aws_rds_helper_unix.sh"
          delete_secrets ${{ env.AURORA_CLUSTER_SECRETS_ARN }}
      - name: Debug - Get Github Action IP
        if: always()
        uses: haythem/public-ip@v1.3
      # Make sure IP is always deleted
      - name: Remove Github Action IP
        if: always()
        shell: bash
        run: |
          . "./scripts/aws_rds_helper_unix.sh"
          remove_ip_from_db_sg \
            ${{ steps.ip.outputs.ipv4 }} \
            ${{ env.AURORA_CLUSTER_ID }} \
            ${{ secrets.AWS_DEFAULT_REGION }}
      # - name: Copy Driver Logs
      #   shell: bash
      #   run: |
      #     cp '${{ runner.temp }}/aws-odbc-wrapper/*.log.*' '${{ github.workspace }}\logs'
      - name: Archive log results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: 'mac-${{matrix.rds_engine}}-test-logs'
          path: ${{steps.log_location.outputs.TEMP}}/aws-odbc-wrapper/
          retention-days: 3
      - name: Archive psql logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: 'mac-${{matrix.rds_engine}}-psql-logs'
          path: logs
          retention-days: 3

  linux-integration-tests:
    name: Linux Ubuntu - Integration Tests
    needs: [build-linux-psqlodbc, build-linux-mysql]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        rds_engine: [aurora-postgresql, aurora-mysql]
    steps:
      - name: Setup Cluster ID
        run: |
          echo "AURORA_CLUSTER_ID=ODBC-Linux-${{ matrix.rds_engine }}-${{github.run_id}}${{github.run_number}}${{github.run_attempt}}" >> $GITHUB_ENV
      - name: Setup Custom Endpoint ID
        run: |
          echo "CUSTOM_ENDPOINT_ID=CUSTOM-ENDPOINT-${{env.AURORA_CLUSTER_ID}}" >> $GITHUB_ENV
      - name: Checkout aws-advanced-odbc-wrapper
        uses: actions/checkout@v4
      - name: Install Build Dependencies
        run: |
          sudo apt update
          sudo apt-get install cmake libcurl4-openssl-dev libssl-dev odbcinst unixodbc-dev uuid-dev zlib1g-dev gdb
      - name: Retrieve AWS SDK for C++ Cache
        id: cache-aws-sdk
        uses: actions/cache@v4
        with:
          path: aws_sdk/install
          key: ${{ runner.os }}-aws-sdk-cpp-${{env.BUILD_CONFIG}}-shared
      - name: Build AWS SDK for C++
        if: ${{steps.cache-aws-sdk.outputs.cache-hit != 'true'}}
        run: |
          ./scripts/compile_aws_sdk_unix.sh ${{env.BUILD_CONFIG}}
      - name: Build aws-advanced-odbc-wrapper
        run: |
          cmake -S . -B build -DBUILD_UNICODE=ON -DBUILD_ANSI=ON -DBUILD_UNIT_TEST=OFF -DCMAKE_BUILD_TYPE=${{env.BUILD_CONFIG}}
          cmake --build build
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ secrets.AWS_DEFAULT_REGION }}
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/${{ secrets.AWS_DEPLOY_ROLE }}
          role-session-name: odbc-wrapper-linux-inte
      - name: Create RDS Cluster
        id: AuroraClusterSetup
        shell: bash
        run: |
          . "./scripts/aws_rds_helper_unix.sh"
          create_aurora_rds_cluster \
            ${{ secrets.TEST_USERNAME }} \
            ${{ secrets.TEST_PASSWORD }} \
            ${{ env.TEST_DATABASE }} \
            ${{ env.AURORA_CLUSTER_ID }} \
            ${{ env.NUM_INSTANCES }} \
            ${{ matrix.rds_engine }} \
            ${{ env.ENGINE_VERSION }} \
            ${{ secrets.AWS_DEFAULT_REGION }}
      - name: Create RDS Custom Endpoint
        id: AuroraCustomEndpointSetup
        shell: bash
        run: |
          . "./scripts/aws_rds_helper_unix.sh"
          create_custom_endpoint \
            ${{ env.CUSTOM_ENDPOINT_ID }} \
            ${{ env.AURORA_CLUSTER_ID }} \
            ${{ env.NUM_INSTANCES }} \
            --static
      - name: Get Aurora Cluster endpoint
        shell: bash
        run: |
          . "./scripts/aws_rds_helper_unix.sh"
          endpoint=$(get_cluster_endpoint ${{ env.AURORA_CLUSTER_ID }})
          echo "AURORA_CLUSTER_ENDPOINT=$endpoint" >> $GITHUB_ENV
      - name: Create Aurora Cluster Secrets
        shell: bash
        run: |
            . "./scripts/aws_rds_helper_unix.sh"
            secretsArn=$(create_db_secrets \
                ${{ secrets.TEST_USERNAME }} \
                ${{ secrets.TEST_PASSWORD }} \
                ${{ matrix.rds_engine }} \
                ${{ env.AURORA_CLUSTER_ENDPOINT }})
            echo "::add-mask::$secretsArn"
            echo "AURORA_CLUSTER_SECRETS_ARN=$secretsArn" >> $GITHUB_ENV
      - name: Get Github Action IP
        if: always()
        id: ip
        run: |
          echo "ipv4=$(curl -s http://checkip.amazonaws.com)" >> $GITHUB_OUTPUT
      - name: Add IP to Allowlist
        run: |
          . "scripts/aws_rds_helper_unix.sh"
          add_ip_to_db_sg \
            ${{ steps.ip.outputs.ipv4 }} \
            ${{ env.AURORA_CLUSTER_ID }} \
            ${{ secrets.AWS_DEFAULT_REGION }}
      - name: Setup Base Driver Variables
        id: base_driver_info
        shell: bash
        run: |
          if [ "${{ matrix.rds_engine }}" == "aurora-postgresql" ]; then
            echo "cache_path=psqlodbc/.libs/" >> $GITHUB_OUTPUT
            echo "cache_key=${{ runner.os }}-psqlodbc-driver" >> $GITHUB_OUTPUT
            echo "driver_path_ansi='${{ github.workspace }}/psqlodbc/.libs/psqlodbca.so'" >> $GITHUB_OUTPUT
            echo "driver_path_unicode='${{ github.workspace }}/psqlodbc/.libs/psqlodbcw.so'" >> $GITHUB_OUTPUT
            echo "dialect_default_port=5432" >> $GITHUB_OUTPUT
            echo "database_dialect=AURORA_POSTGRESQL" >> $GITHUB_OUTPUT
          elif [ "${{ matrix.rds_engine }}" == "aurora-mysql" ]; then
            echo "cache_path=mysql-connector/" >> $GITHUB_OUTPUT
            echo "cache_key=${{ runner.os }}-mysql-driver" >> $GITHUB_OUTPUT
            echo "driver_path_ansi='/usr/lib/x86_64-linux-gnu/odbc/libmyodbc9a.so'" >> $GITHUB_OUTPUT
            echo "driver_path_unicode='/usr/lib/x86_64-linux-gnu/odbc/libmyodbc9w.so'" >> $GITHUB_OUTPUT
            echo "dialect_default_port=3306" >> $GITHUB_OUTPUT
            echo "database_dialect=AURORA_MYSQL" >> $GITHUB_OUTPUT
          fi
      - name: Retrieve Base Driver
        uses: actions/cache@v4
        with:
          path: ${{steps.base_driver_info.outputs.cache_path}}
          key: ${{steps.base_driver_info.outputs.cache_key}}
          fail-on-cache-miss: true
      - name: Setup PostgreSQL User
        if: (matrix.rds_engine == 'aurora-postgresql')
        shell: bash
        run: |
          echo "$(pg_config --bindir)" >> $GITHUB_PATH
          psql postgresql://${{ secrets.TEST_USERNAME }}:${{ secrets.TEST_PASSWORD }}@${{env.AURORA_CLUSTER_ENDPOINT}}:${{steps.base_driver_info.outputs.dialect_default_port}}/${{ env.TEST_DATABASE }} \
            --command="CREATE USER ${{ secrets.TEST_IAM_USER }};" \
            --command="GRANT rds_iam TO ${{ secrets.TEST_IAM_USER }};" \
            --command="\du"
      - name: Install MySQL
        if: (matrix.rds_engine == 'aurora-mysql')
        shell: bash
        run: |
          sudo apt install ./mysql-connector/mysql-connector_x64.deb -y
      - name: Setup MySQL User
        if: (matrix.rds_engine == 'aurora-mysql')
        shell: bash
        working-directory: ${{steps.base_driver_info.outputs.cache_path}}
        run: |
          mysql -h ${{ env.AURORA_CLUSTER_ENDPOINT }} -P 3306 -D ${{ env.TEST_DATABASE }} -u ${{ secrets.TEST_USERNAME }} -p${{ secrets.TEST_PASSWORD }} --execute="CREATE USER '${{ secrets.TEST_IAM_USER }}' IDENTIFIED WITH AWSAuthenticationPlugin AS 'RDS'; GRANT ALL on ${{ env.TEST_DATABASE }}.* TO '${{ secrets.TEST_IAM_USER }}'@'%'; FLUSH PRIVILEGES;"
      - name: Create logs folder
        run: mkdir logs
      - name: Build and Run Ansi Integration Tests
        shell: bash
        if: ${{ !cancelled() && steps.auroraClusterSetup.outcome == 'success'}}
        run: |
          cmake -S test/integration -B build_ansi \
            -D BUILD_UNICODE=OFF -D BUILD_FAILOVER=ON -D BUILD_LIMITLESS=OFF \
            -D CMAKE_BUILD_TYPE=${{env.BUILD_CONFIG}} \
            -D TEST_DRIVER_PATH="${{ github.workspace }}/build/driver/aws-advanced-odbc-wrapper-a.so" \
            -D BASE_DRIVER_PATH="${{steps.base_driver_info.outputs.driver_path_ansi}}" \
            -D TEST_SERVER="${{ env.AURORA_CLUSTER_ENDPOINT }}" \
            -D TEST_DATABASE="${{ env.TEST_DATABASE }}"
          cmake --build build_ansi
          echo "Ansi Test Built"
          cat ${{ github.workspace }}/test/resources/odbc.ini
          cat ${{ github.workspace }}/test/resources/odbcinst.ini
          gdb -ex run ./build_ansi/integration-test
        env:
          TEST_DSN: "inte-wrapper-dsn"
          TEST_DATABASE: ${{ env.TEST_DATABASE }}
          TEST_USERNAME: ${{ secrets.TEST_USERNAME }}
          TEST_PASSWORD: ${{ secrets.TEST_PASSWORD }}
          TEST_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
          TEST_IAM_USER: ${{ secrets.TEST_IAM_USER }}
          TEST_SECRET_ARN: ${{ env.AURORA_CLUSTER_SECRETS_ARN }}
          TEST_SERVER: ${{ env.AURORA_CLUSTER_ENDPOINT }}
          TEST_PORT: "${{ steps.base_driver_info.outputs.dialect_default_port }}"
          TEST_DIALECT: "${{ steps.base_driver_info.outputs.database_dialect }}"
          ODBCINI: "${{ github.workspace }}/test/resources/odbc.ini"
          ODBCINST: "${{ github.workspace }}/test/resources/odbcinst.ini"
          TEST_CUSTOM_ENDPOINT_ID: "${{ env.CUSTOM_ENDPOINT_ID }}"
          # ASAN_OPTIONS: 'detect_container_overflow=0,symbolize=1,print_module_map=2'
      - name: Build and Run Unicode Integration Tests
        shell: bash
        if: ${{steps.AuroraClusterSetup.outcome == 'success'}}
        run: |
          cmake -S test/integration -B build_unicode \
            -D BUILD_UNICODE=ON -D BUILD_FAILOVER=ON -D BUILD_LIMITLESS=OFF \
            -D CMAKE_BUILD_TYPE=${{env.BUILD_CONFIG}} \
            -D TEST_DRIVER_PATH="${{ github.workspace }}/build/driver/aws-advanced-odbc-wrapper-w.so" \
            -D BASE_DRIVER_PATH="${{steps.base_driver_info.outputs.driver_path_unicode}}" \
            -D TEST_SERVER="${{ env.AURORA_CLUSTER_ENDPOINT }}" \
            -D TEST_DATABASE="${{ env.TEST_DATABASE }}"
          cmake --build build_unicode
          echo "Unicode Test Built"
          cat ${{ github.workspace }}/test/resources/odbc.ini
          cat ${{ github.workspace }}/test/resources/odbcinst.ini
          ./build_unicode/integration-test
        env:
          TEST_DSN: "inte-wrapper-dsn"
          TEST_DATABASE: ${{ env.TEST_DATABASE }}
          TEST_USERNAME: ${{ secrets.TEST_USERNAME }}
          TEST_PASSWORD: ${{ secrets.TEST_PASSWORD }}
          TEST_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
          TEST_IAM_USER: ${{ secrets.TEST_IAM_USER }}
          TEST_SECRET_ARN: ${{ env.AURORA_CLUSTER_SECRETS_ARN }}
          TEST_SERVER: ${{ env.AURORA_CLUSTER_ENDPOINT }}
          TEST_PORT: "${{ steps.base_driver_info.outputs.dialect_default_port }}"
          TEST_DIALECT: "${{ steps.base_driver_info.outputs.database_dialect }}"
          ODBCINI: "${{ github.workspace }}/test/resources/odbc.ini"
          ODBCINST: "${{ github.workspace }}/test/resources/odbcinst.ini"
          TEST_CUSTOM_ENDPOINT_ID: "${{ env.CUSTOM_ENDPOINT_ID }}"
      - name: Delete RDS Custom Endpoint
        if: always()
        shell: bash
        run: |
          . "./scripts/aws_rds_helper_unix.sh"
          delete_custom_endpoint ${{ env.CUSTOM_ENDPOINT_ID }} ${{ env.AURORA_CLUSTER_ID }}
      - name: Delete Aurora RDS Cluster
        if: always()
        shell: bash
        run: |
          . "./scripts/aws_rds_helper_unix.sh"
          delete_aurora_db_cluster ${{ env.AURORA_CLUSTER_ID }} ${{ secrets.AWS_DEFAULT_REGION }} ${{ env.NUM_INSTANCES }}
      - name: Delete Aurora Db Secrets
        if: always()
        shell: bash
        run: |
          . "./scripts/aws_rds_helper_unix.sh"
          delete_secrets ${{ env.AURORA_CLUSTER_SECRETS_ARN }}
      # Make sure IP is always deleted
      - name: Remove Github Action IP
        if: always()
        shell: bash
        run: |
          . "./scripts/aws_rds_helper_unix.sh"
          remove_ip_from_db_sg \
            ${{ steps.ip.outputs.ipv4 }} \
            ${{ env.AURORA_CLUSTER_ID }} \
            ${{ secrets.AWS_DEFAULT_REGION }}
      - name: Archive log results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: 'linux-${{matrix.rds_engine}}-test-logs'
          path: /tmp/aws-odbc-wrapper/
          retention-days: 3
      - name: Archive psql logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: 'linux-${{matrix.rds_engine}}-psql-logs'
          path: logs/
          retention-days: 3

  windows-limitless-integration-tests:
    name: Windows - Limitless Integration Tests
    needs: [build-win-psqlodbc]
    runs-on: windows-latest
    steps:
      - name: Setup Cluster ID and Shard ID Env Variables
        run: |
          echo "LIMITLESS_CLUSTER_ID=AWS-ODBC-Win-Limitless-${{github.run_id}}${{github.run_number}}${{github.run_attempt}}" | Out-File -FilePath $env:GITHUB_ENV -Append
          echo "LIMITLESS_SHARD_ID=AWS-ODBC-Win-Shard-${{github.run_id}}${{github.run_number}}${{github.run_attempt}}" | Out-File -FilePath $env:GITHUB_ENV -Append
      - name: Checkout aws-advanced-odbc-wrapper
        uses: actions/checkout@v4
      - name: Retrieve AWS SDK for C++ Cache
        id: cache-aws-sdk
        uses: actions/cache@v4
        with:
          path: aws_sdk/install
          key: ${{ runner.os }}-aws-sdk-cpp-${{env.BUILD_CONFIG}}-shared
      - name: Build AWS SDK for C++
        if: ${{steps.cache-aws-sdk.outputs.cache-hit != 'true'}}
        run: |
          ./scripts/compile_aws_sdk_win.ps1 ${{env.BUILD_CONFIG}}
      - name: Setup Dotnet for WiX
        uses: actions/setup-dotnet@v4
      - name: Install WiX
        shell: cmd
        run: |
          dotnet tool install --global wix --version ${{env.WIX_VERSION}}
          wix extension add --global WixToolset.UI.wixext/${{env.WIX_VERSION}}
      - name: Run build installer script
        shell: pwsh
        run: |
          ./installer/build_installer.ps1 ${{env.BUILD_CONFIG}}
      - name: Retrieve psqlODBC Cache
        uses: actions/cache@v4
        with:
          path: psqlodbc
          key: ${{ runner.os }}-psqlodbc-driver
          fail-on-cache-miss: true
      - name: Install psqlODBC Driver
        shell: pwsh
        working-directory: psqlodbc
        run: |
          Start-Process msiexec "/i psqlodbc_x64.msi /quiet /norestart" -Wait;
      - name: Install driver
        shell: pwsh
        working-directory: installer
        run: Start-Process msiexec "/lp! .\test.log /i aws-advanced-odbc-wrapper.msi /quiet /norestart" -Wait;
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ secrets.AWS_DEFAULT_REGION }}
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/${{ secrets.AWS_DEPLOY_ROLE }}
          role-session-name: odbc-wrapper-win-inte
      - name: Create Limitless RDS Cluster
        id: AuroraClusterSetup
        shell: pwsh
        working-directory: ./scripts
        run: |
          . ".\aws_rds_helper_win.ps1"
            Create-Limitless-RDS-Cluster `
            -TestUsername ${{ secrets.TEST_USERNAME }} `
            -TestPassword ${{ secrets.TEST_PASSWORD }} `
            -TestDatabase ${{ env.TEST_LIMITLESS_DATABASE }} `
            -ClusterId ${{ env.LIMITLESS_CLUSTER_ID }} `
            -ShardId ${{ env.LIMITLESS_SHARD_ID }} `
            -Engine aurora-postgresql `
            -EngineVersion ${{ env.ENGINE_LIMITLESS_VERSION }} `
            -AwsRdsMonitoringRoleArn ${{ secrets.AWS_RDS_MONITORING_ROLE_ARN }} `
            -Region ${{ secrets.AWS_DEFAULT_REGION }}
      - name: Get Limitless Cluster endpoint
        shell: pwsh
        working-directory: ./scripts
        run: |
          . ".\aws_rds_helper_win.ps1"
          $endpoint = (Get-Cluster-Endpoint -ClusterId ${{ env.LIMITLESS_CLUSTER_ID }})
          echo "LIMITLESS_CLUSTER_ENDPOINT=$endpoint" | Out-File -FilePath $env:GITHUB_ENV -Append
      - name: Create Aurora Cluster Secrets
        shell: pwsh
        working-directory: ./scripts
        run: |
            . ".\aws_rds_helper_win.ps1"
            $secrets = (Create-Db-Secrets `
              -Username ${{ secrets.TEST_USERNAME }} `
              -Password ${{ secrets.TEST_PASSWORD }} `
              -Engine "aurora-postgresql" `
              -ClusterEndpoint ${{ env.LIMITLESS_CLUSTER_ENDPOINT }})
            echo "::add-mask::$secrets"
            echo "AURORA_CLUSTER_SECRETS_ARN=$secrets" | Out-File -FilePath $env:GITHUB_ENV -Append
      - name: Add PostgreSQL binaries to PATH
        shell: bash
        run: |
          echo "$PGBIN" >> $GITHUB_PATH
      - name: Create IAM DB User for PostgreSQL
        shell: bash
        run: |
          psql postgresql://${{ secrets.TEST_USERNAME }}:${{ secrets.TEST_PASSWORD }}@${{env.LIMITLESS_CLUSTER_ENDPOINT}}:5432/${{ env.TEST_LIMITLESS_DATABASE }} \
            --command="CREATE USER ${{ secrets.TEST_IAM_USER }};" \
            --command="GRANT rds_iam TO ${{ secrets.TEST_IAM_USER }};" \
            --command="\du"
      - name: Install Ansi DSNs
        shell: pwsh
        run: |
            Add-OdbcDsn -Name ${{ env.TEST_DSN_ANSI }} `
              -DriverName "${{ env.DRIVER_NAME_ANSI }}" `
              -DsnType User `
              -SetPropertyValue `
              @("RDS_AUTH_TYPE=database", `
              "Server=${{ env.LIMITLESS_CLUSTER_ENDPOINT }}", `
              "Port=5432", `
              "SSLMode=prefer", `
              "BASE_DRIVER=C:\Program Files\psqlODBC\1700\bin\podbc30a.dll")
      - name: Install Unicode DSNs
        shell: pwsh
        run: |
            Add-OdbcDsn -Name ${{ env.TEST_DSN_UNICODE }} `
              -DriverName "${{ env.DRIVER_NAME_UNICODE }}" `
              -DsnType User `
              -SetPropertyValue `
              @("RDS_AUTH_TYPE=database", `
              "Server=${{ env.LIMITLESS_CLUSTER_ENDPOINT }}", `
              "Port=5432", `
              "SSLMode=prefer", `
              "BASE_DRIVER=C:\Program Files\psqlODBC\1700\bin\podbc35w.dll")
      - name: Create logs folder
        run: mkdir logs
      - name: Build and Run Ansi Integration Tests
        shell: pwsh
        if: ${{steps.AuroraClusterSetup.outcome == 'success'}}
        run: |
          cmake -S test/integration -B build_ansi -DCMAKE_BUILD_TYPE="${{env.BUILD_CONFIG}}" `
            -DBUILD_UNICODE=OFF -DBUILD_FAILOVER=OFF -DBUILD_LIMITLESS=ON
          cmake --build build_ansi --config ${{env.BUILD_CONFIG}}
          echo "Ansi Test Built"
          gdb -ex run .\build_ansi\${{env.BUILD_CONFIG}}\integration-test.exe
        env:
          TEST_DSN: ${{ env.TEST_DSN_ANSI }}
          TEST_DATABASE: ${{ env.TEST_LIMITLESS_DATABASE }}
          TEST_USERNAME: ${{ secrets.TEST_USERNAME }}
          TEST_PASSWORD: ${{ secrets.TEST_PASSWORD }}
          TEST_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
          TEST_IAM_USER: ${{ secrets.TEST_IAM_USER }}
          TEST_SECRET_ARN: ${{ env.AURORA_CLUSTER_SECRETS_ARN }}
          TEST_SERVER: ${{ env.LIMITLESS_CLUSTER_ENDPOINT }}
          TEST_PORT: '5432'
      - name: Build and Run Unicode Integration Tests
        shell: pwsh
        if: ${{steps.AuroraClusterSetup.outcome == 'success'}}
        run: |
          cmake -S test/integration -B build_unicode -DCMAKE_BUILD_TYPE=${{env.BUILD_CONFIG}} `
            -DBUILD_UNICODE=ON -DBUILD_FAILOVER=OFF -DBUILD_LIMITLESS=ON
          cmake --build build_unicode --config ${{env.BUILD_CONFIG}}
          echo "Unicode Test Built"
          .\build_unicode\${{env.BUILD_CONFIG}}\integration-test.exe
        env:
          TEST_DSN: ${{ env.TEST_DSN_UNICODE }}
          TEST_DATABASE: ${{ env.TEST_LIMITLESS_DATABASE }}
          TEST_USERNAME: ${{ secrets.TEST_USERNAME }}
          TEST_PASSWORD: ${{ secrets.TEST_PASSWORD }}
          TEST_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
          TEST_IAM_USER: ${{ secrets.TEST_IAM_USER }}
          TEST_SECRET_ARN: ${{ env.AURORA_CLUSTER_SECRETS_ARN }}
          TEST_SERVER: ${{ env.LIMITLESS_CLUSTER_ENDPOINT }}
          TEST_PORT: '5432'
      - name: Delete Aurora RDS Cluster
        if: always()
        shell: pwsh
        working-directory: ./scripts
        run: |
          . ".\aws_rds_helper_win.ps1"
          Delete-Limitless-Db-Cluster -ClusterId ${{ env.LIMITLESS_CLUSTER_ID }} -ShardId ${{ env.LIMITLESS_SHARD_ID }} -Region ${{ secrets.AWS_DEFAULT_REGION }}
      - name: Delete Aurora Db Secrets
        if: always()
        shell: pwsh
        working-directory: ./scripts
        run: |
          . ".\aws_rds_helper_win.ps1"
          Delete-Secrets ${{ env.AURORA_CLUSTER_SECRETS_ARN }}
      # Make sure IP is always deleted
      - name: Get Github Action IP
        if: always()
        id: ip
        uses: haythem/public-ip@v1.3
      - name: Remove Github Action IP
        if: always()
        run: |
          aws ec2 revoke-security-group-ingress `
            --group-name default `
            --protocol tcp `
            --port 0-65535 `
            --cidr ${{ steps.ip.outputs.ipv4 }}/32 `
           *> $null;
      # - name: Copy Driver Logs
      #   shell: pwsh
      #   run: |
      #     Copy-Item -Path '${{ runner.temp }}/aws-odbc-wrapper/*.log.*' -Destination '${{ github.workspace }}\logs'
      - name: Archive log results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: 'windows-limitless-integration-test-logs'
          path: C:\Users\runneradmin\AppData\Local\Temp\aws-odbc-wrapper\
          retention-days: 3
      - name: Archive psql logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: 'windows-limitless-psql-logs'
          path: logs
          retention-days: 3

  macos-limitless-integration-tests:
    name: MacOS - Limitless Integration Tests
    if: github.event_name == 'workflow_dispatch'
    needs: [build-macos-psqlodbc]
    runs-on: macos-15
    steps:
      - name: Setup Cluster ID
        run: |
          echo "LIMITLESS_CLUSTER_ID=AWS-ODBC-Macos-Limitless-${{github.run_id}}${{github.run_number}}${{github.run_attempt}}" >> $GITHUB_ENV
          echo "LIMITLESS_SHARD_ID=AWS-ODBC-Macos-Shard-${{github.run_id}}${{github.run_number}}${{github.run_attempt}}" >> $GITHUB_ENV
      - name: Checkout aws-advanced-odbc-wrapper
        uses: actions/checkout@v4
      - name: Install Build Dependencies
        run: |
          brew update && brew upgrade && brew cleanup
          brew install cmake unixodbc postgresql curl openssl zlib icu4c
      - name: Retrieve AWS SDK for C++ Cache
        id: cache-aws-sdk
        uses: actions/cache@v4
        with:
          path: aws_sdk/install
          key: ${{ runner.os }}-aws-sdk-cpp-${{env.BUILD_CONFIG}}-shared
      - name: Build AWS SDK for C++
        if: ${{steps.cache-aws-sdk.outputs.cache-hit != 'true'}}
        run: |
          export SDKROOT="$(xcrun --sdk macosx --show-sdk-path)"
          ./scripts/compile_aws_sdk_unix.sh ${{env.BUILD_CONFIG}}
      - name: Build aws-advanced-odbc-wrapper
        run: |
          cmake -S . -B build -DBUILD_UNICODE=ON -DBUILD_ANSI=ON -DBUILD_UNIT_TEST=OFF -DCMAKE_BUILD_TYPE=${{env.BUILD_CONFIG}}
          cmake --build build
      - name: Retrieve psqlODBC Cache
        id: cache-psqlodbc
        uses: actions/cache@v4
        with:
          path: psqlodbc/.libs/
          key: ${{ runner.os }}-psqlodbc-driver
          fail-on-cache-miss: true
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ secrets.AWS_DEFAULT_REGION }}
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/${{ secrets.AWS_DEPLOY_ROLE }}
          role-session-name: odbc-wrapper-macos-inte
      - name: Create Limitless RDS Cluster
        id: AuroraClusterSetup
        shell: bash
        run: |
          . "./scripts/aws_rds_helper_unix.sh"
          create_limitless_rds_cluster \
            ${{ secrets.TEST_USERNAME }} \
            ${{ secrets.TEST_PASSWORD }} \
            ${{ env.TEST_LIMITLESS_DATABASE }} \
            ${{ env.LIMITLESS_CLUSTER_ID }} \
            ${{ env.LIMITLESS_SHARD_ID }} \
            aurora-postgresql \
            ${{ env.ENGINE_VERSION }} \
            ${{ secrets.AWS_RDS_MONITORING_ROLE_ARN }} \
            ${{ secrets.AWS_DEFAULT_REGION }}
      - name: Get Limitless Cluster endpoint
        shell: bash
        run: |
          . "./scripts/aws_rds_helper_unix.sh"
          endpoint=$(get_cluster_endpoint ${{ env.LIMITLESS_CLUSTER_ID }})
          echo "LIMITLESS_CLUSTER_ENDPOINT=$endpoint" >> $GITHUB_ENV
      - name: Create Aurora Cluster Secrets
        shell: bash
        run: |
            . "./scripts/aws_rds_helper_unix.sh"
            secretsArn=$(create_db_secrets \
                ${{ secrets.TEST_USERNAME }} \
                ${{ secrets.TEST_PASSWORD }} \
                aurora-postgresql \
                ${{ env.LIMITLESS_CLUSTER_ENDPOINT }})
            echo "::add-mask::$secretsArn"
            echo "AURORA_CLUSTER_SECRETS_ARN=$secretsArn" >> $GITHUB_ENV
      - name: Install PostgreSQL on macOS
        if: runner.os == 'macOS'
        run: |
          brew install postgresql@16
          # --overwrite: Overwrite pre-installed GitHub Actions PostgreSQL binaries
          brew link --overwrite postgresql@16
      - name: Get Github Action IP
        if: always()
        id: ip
        run: |
          echo "ipv4=$(curl -s http://checkip.amazonaws.com)" >> $GITHUB_OUTPUT
      - name: Add IP to Allowlist
        run: |
          . "scripts/aws_rds_helper_unix.sh"
          add_ip_to_db_sg \
            ${{ steps.ip.outputs.ipv4 }} \
            ${{ env.LIMITLESS_CLUSTER_ID }} \
            ${{ secrets.AWS_DEFAULT_REGION }}
      - name: Create IAM DB User for PostgreSQL
        shell: bash
        run: |
          psql postgresql://${{ secrets.TEST_USERNAME }}:${{ secrets.TEST_PASSWORD }}@${{env.LIMITLESS_CLUSTER_ENDPOINT}}:5432/${{ env.TEST_LIMITLESS_DATABASE }} \
            --command="CREATE USER ${{ secrets.TEST_IAM_USER }};" \
            --command="GRANT rds_iam TO ${{ secrets.TEST_IAM_USER }};" \
            --command="\du"
      - name: Create logs folder
        run: mkdir logs
      - name: Build and Run Ansi Integration Tests
        shell: bash
        if: ${{ !cancelled() && steps.auroraClusterSetup.outcome == 'success'}}
        run: |
          cmake -S test/integration -B build_ansi \
            -D BUILD_UNICODE=OFF -D BUILD_FAILOVER=OFF -D BUILD_LIMITLESS=ON \
            -D CMAKE_BUILD_TYPE=${{env.BUILD_CONFIG}} \
            -D TEST_SERVER="${{ env.LIMITLESS_CLUSTER_ENDPOINT }}" \
            -D TEST_PORT="5432" \
            -D TEST_DATABASE="${{ env.TEST_LIMITLESS_DATABASE }}" \
            -D TEST_DSN="${{ env.TEST_DSN_ANSI }}" \
            -D TEST_DRIVER_PATH="${{ github.workspace }}/build/driver/aws-advanced-odbc-wrapper-a.dylib" \
            -D BASE_PG_DRIVER_PATH="${{ github.workspace }}/psqlodbc/.libs/psqlodbca.so"
          cmake --build build_ansi
          echo "Ansi Test Built"
          ./build_ansi/integration-test
        env:
          TEST_DSN: ${{ env.TEST_DSN_ANSI }}
          TEST_DATABASE: ${{ env.TEST_LIMITLESS_DATABASE }}
          TEST_USERNAME: ${{ secrets.TEST_USERNAME }}
          TEST_PASSWORD: ${{ secrets.TEST_PASSWORD }}
          TEST_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
          TEST_IAM_USER: ${{ secrets.TEST_IAM_USER }}
          TEST_SECRET_ARN: ${{ env.AURORA_CLUSTER_SECRETS_ARN }}
          TEST_SERVER: ${{ env.LIMITLESS_CLUSTER_ENDPOINT }}
          TEST_PORT: '5432'
          ODBCINI: "${{ github.workspace }}/test/resources/odbc.ini"
          ODBCINST: "${{ github.workspace }}/test/resources/odbcinst.ini"
          # ASAN_OPTIONS: 'detect_container_overflow=0'
      - name: Build and Run Unicode Integration Tests
        shell: bash
        if: ${{steps.AuroraClusterSetup.outcome == 'success'}}
        run: |
          cmake -S test/integration -B build_unicode \
            -DBUILD_UNICODE=ON -DBUILD_FAILOVER=OFF -DBUILD_LIMITLESS=ON -DCMAKE_BUILD_TYPE=${{env.BUILD_CONFIG}} \
            -DTEST_SERVER="${{ env.AURORA_CLUSTER_ENDPOINT }}" \
            -DTEST_PORT="5432" \
            -DTEST_DATABASE="${{ env.TEST_LIMITLESS_DATABASE }}" \
            -DTEST_DSN="${{ env.TEST_DSN_UNICODE }}" \
            -DTEST_DRIVER_PATH="${{ github.workspace }}/build/driver/aws-advanced-odbc-wrapper-w.dylib" \
            -DBASE_PG_DRIVER_PATH="${{ github.workspace }}/psqlodbc/.libs/psqlodbcw.so"
          cmake --build build_unicode
          echo "Unicode Test Built"
          ./build_unicode/integration-test
        env:
          TEST_DSN: ${{ env.TEST_DSN_UNICODE }}
          TEST_DATABASE: ${{ env.TEST_LIMITLESS_DATABASE }}
          TEST_USERNAME: ${{ secrets.TEST_USERNAME }}
          TEST_PASSWORD: ${{ secrets.TEST_PASSWORD }}
          TEST_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
          TEST_IAM_USER: ${{ secrets.TEST_IAM_USER }}
          TEST_SECRET_ARN: ${{ env.AURORA_CLUSTER_SECRETS_ARN }}
          TEST_SERVER: ${{ env.LIMITLESS_CLUSTER_ENDPOINT }}
          TEST_PORT: '5432'
          ODBCINI: "${{ github.workspace }}/test/resources/odbc.ini"
          ODBCINST: "${{ github.workspace }}/test/resources/odbcinst.ini"
      - name: Get log location
        id: log_location
        run: echo "TEMP=$(echo $TMPDIR)" >> $GITHUB_OUTPUT
      - name: Delete Aurora RDS Cluster
        if: always()
        shell: bash
        run: |
          . "./scripts/aws_rds_helper_unix.sh"
          delete_limitless_db_cluster ${{ env.LIMITLESS_CLUSTER_ID }} ${{ env.LIMITLESS_SHARD_ID }} ${{ secrets.AWS_DEFAULT_REGION }}
      - name: Delete Aurora Db Secrets
        if: always()
        shell: bash
        run: |
          . "./scripts/aws_rds_helper_unix.sh"
          delete_secrets ${{ env.AURORA_CLUSTER_SECRETS_ARN }}
      - name: Debug - Get Github Action IP
        if: always()
        uses: haythem/public-ip@v1.3
      # Make sure IP is always deleted
      - name: Remove Github Action IP
        if: always()
        shell: bash
        run: |
          . "./scripts/aws_rds_helper_unix.sh"
          remove_ip_from_db_sg \
            ${{ steps.ip.outputs.ipv4 }} \
            ${{ env.LIMITLESS_CLUSTER_ID }} \
            ${{ secrets.AWS_DEFAULT_REGION }}
      # - name: Copy Driver Logs
      #   shell: bash
      #   run: |
      #     cp '${{ runner.temp }}/aws-odbc-wrapper/*.log.*' '${{ github.workspace }}\logs'
      - name: Archive log results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: 'mac-limitless-integration-test-logs'
          path: ${{steps.log_location.outputs.TEMP}}/aws-odbc-wrapper/
          retention-days: 3
      - name: Archive psql logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: 'mac-limitless-psql-logs'
          path: logs/
          retention-days: 3

  linux-limitless-integration-tests:
    name: Linux Ubuntu - Limitless Integration Tests
    needs: [build-linux-psqlodbc]
    runs-on: ubuntu-latest
    steps:
      - name: Setup Cluster ID
        run: |
          echo "LIMITLESS_CLUSTER_ID=AWS-ODBC-Linux-Limitless-${{github.run_id}}${{github.run_number}}${{github.run_attempt}}" >> $GITHUB_ENV
          echo "LIMITLESS_SHARD_ID=AWS-ODBC-Linux-Shard-${{github.run_id}}${{github.run_number}}${{github.run_attempt}}" >> $GITHUB_ENV
      - name: Checkout aws-advanced-odbc-wrapper
        uses: actions/checkout@v4
      - name: Install Build Dependencies
        run: |
          sudo apt update
          sudo apt-get install cmake libcurl4-openssl-dev libssl-dev odbcinst unixodbc-dev uuid-dev zlib1g-dev gdb
      - name: Retrieve AWS SDK for C++ Cache
        id: cache-aws-sdk
        uses: actions/cache@v4
        with:
          path: aws_sdk/install
          key: ${{ runner.os }}-aws-sdk-cpp-${{env.BUILD_CONFIG}}-shared
      - name: Build AWS SDK for C++
        if: ${{steps.cache-aws-sdk.outputs.cache-hit != 'true'}}
        run: |
          ./scripts/compile_aws_sdk_unix.sh ${{env.BUILD_CONFIG}}
      - name: Build aws-advanced-odbc-wrapper
        run: |
          cmake -S . -B build -DBUILD_UNICODE=ON -DBUILD_ANSI=ON -DBUILD_UNIT_TEST=OFF -DCMAKE_BUILD_TYPE=${{env.BUILD_CONFIG}}
          cmake --build build
      - name: Retrieve psqlODBC Cache
        id: cache-psqlodbc
        uses: actions/cache@v4
        with:
          path: psqlodbc/.libs/
          key: ${{ runner.os }}-psqlodbc-driver
          fail-on-cache-miss: true
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ secrets.AWS_DEFAULT_REGION }}
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/${{ secrets.AWS_DEPLOY_ROLE }}
          role-session-name: odbc-wrapper-linux-inte
      - name: Create Limitless RDS Cluster
        id: AuroraClusterSetup
        shell: bash
        run: |
          . "./scripts/aws_rds_helper_unix.sh"
          create_limitless_rds_cluster \
            ${{ secrets.TEST_USERNAME }} \
            ${{ secrets.TEST_PASSWORD }} \
            ${{ env.TEST_LIMITLESS_DATABASE }} \
            ${{ env.LIMITLESS_CLUSTER_ID }} \
            ${{ env.LIMITLESS_SHARD_ID }} \
            aurora-postgresql \
            ${{ env.ENGINE_VERSION }} \
            ${{ secrets.AWS_RDS_MONITORING_ROLE_ARN }} \
            ${{ secrets.AWS_DEFAULT_REGION }}
      - name: Get Limitless Cluster endpoint
        shell: bash
        run: |
          . "./scripts/aws_rds_helper_unix.sh"
          endpoint=$(get_cluster_endpoint ${{ env.LIMITLESS_CLUSTER_ID }})
          echo "LIMITLESS_CLUSTER_ENDPOINT=$endpoint" >> $GITHUB_ENV
      - name: Create Aurora Cluster Secrets
        shell: bash
        run: |
            . "./scripts/aws_rds_helper_unix.sh"
            secretsArn=$(create_db_secrets \
                ${{ secrets.TEST_USERNAME }} \
                ${{ secrets.TEST_PASSWORD }} \
                aurora-postgresql \
                ${{ env.LIMITLESS_CLUSTER_ENDPOINT }})
            echo "::add-mask::$secretsArn"
            echo "AURORA_CLUSTER_SECRETS_ARN=$secretsArn" >> $GITHUB_ENV
      - name: Add PostgreSQL binaries to PATH
        shell: bash
        run: |
          echo "$(pg_config --bindir)" >> $GITHUB_PATH
      - name: Get Github Action IP
        if: always()
        id: ip
        run: |
          echo "ipv4=$(curl -s http://checkip.amazonaws.com)" >> $GITHUB_OUTPUT
      - name: Add IP to Allowlist
        run: |
          . "scripts/aws_rds_helper_unix.sh"
          add_ip_to_db_sg \
            ${{ steps.ip.outputs.ipv4 }} \
            ${{ env.LIMITLESS_CLUSTER_ID }} \
            ${{ secrets.AWS_DEFAULT_REGION }}
      - name: Create IAM DB User for PostgreSQL
        shell: bash
        run: |
          psql postgresql://${{ secrets.TEST_USERNAME }}:${{ secrets.TEST_PASSWORD }}@${{env.LIMITLESS_CLUSTER_ENDPOINT}}:5432/${{ env.TEST_LIMITLESS_DATABASE }} \
            --command="CREATE USER ${{ secrets.TEST_IAM_USER }};" \
            --command="GRANT rds_iam TO ${{ secrets.TEST_IAM_USER }};" \
            --command="\du"
      - name: Create logs folder
        run: mkdir logs
      - name: Build and Run Ansi Integration Tests
        shell: bash
        if: ${{ !cancelled() && steps.auroraClusterSetup.outcome == 'success'}}
        run: |
          cmake -S test/integration -B build_ansi \
            -D BUILD_UNICODE=OFF -D BUILD_FAILOVER=OFF -D BUILD_LIMITLESS=ON \
            -D CMAKE_BUILD_TYPE=${{env.BUILD_CONFIG}} \
            -D TEST_SERVER="${{ env.LIMITLESS_CLUSTER_ENDPOINT }}" \
            -D TEST_DATABASE="${{ env.TEST_LIMITLESS_DATABASE }}" \
            -D TEST_DSN="${{ env.TEST_DSN_ANSI }}" \
            -D TEST_DRIVER_PATH="${{ github.workspace }}/build/driver/aws-advanced-odbc-wrapper-a.so" \
            -D BASE_DRIVER_PATH="${{ github.workspace }}/psqlodbc/.libs/psqlodbca.so"
          cmake --build build_ansi
          echo "Ansi Test Built"
          gdb -ex run ./build_ansi/integration-test
        env:
          TEST_DSN: "inte-wrapper-dsn"
          TEST_DATABASE: ${{ env.TEST_LIMITLESS_DATABASE }}
          TEST_USERNAME: ${{ secrets.TEST_USERNAME }}
          TEST_PASSWORD: ${{ secrets.TEST_PASSWORD }}
          TEST_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
          TEST_IAM_USER: ${{ secrets.TEST_IAM_USER }}
          TEST_SECRET_ARN: ${{ env.AURORA_CLUSTER_SECRETS_ARN }}
          TEST_SERVER: ${{ env.LIMITLESS_CLUSTER_ENDPOINT }}
          TEST_PORT: '5432'
          ODBCINI: "${{ github.workspace }}/test/resources/odbc.ini"
          ODBCINST: "${{ github.workspace }}/test/resources/odbcinst.ini"
         # ASAN_OPTIONS: 'detect_container_overflow=0'
      - name: Build and Run Unicode Integration Tests
        shell: bash
        if: ${{steps.AuroraClusterSetup.outcome == 'success'}}
        run: |
          cmake -S test/integration -B build_unicode \
            -D BUILD_UNICODE=ON -D BUILD_FAILOVER=OFF -D BUILD_LIMITLESS=ON \
            -D CMAKE_BUILD_TYPE=${{env.BUILD_CONFIG}} \
            -D TEST_SERVER="${{ env.AURORA_CLUSTER_ENDPOINT }}" \
            -D TEST_DATABASE="${{ env.TEST_LIMITLESS_DATABASE }}" \
            -D TEST_DRIVER_PATH="${{ github.workspace }}/build/driver/aws-advanced-odbc-wrapper-w.so" \
            -D BASE_DRIVER_PATH="${{ github.workspace }}/psqlodbc/.libs/psqlodbcw.so"
          cmake --build build_unicode --config ${{env.BUILD_CONFIG}}
          echo "Unicode Test Built"
          ./build_unicode/integration-test
        env:
          TEST_DSN: "inte-wrapper-dsn"
          TEST_DATABASE: ${{ env.TEST_LIMITLESS_DATABASE }}
          TEST_USERNAME: ${{ secrets.TEST_USERNAME }}
          TEST_PASSWORD: ${{ secrets.TEST_PASSWORD }}
          TEST_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
          TEST_IAM_USER: ${{ secrets.TEST_IAM_USER }}
          TEST_SECRET_ARN: ${{ env.AURORA_CLUSTER_SECRETS_ARN }}
          TEST_SERVER: ${{ env.LIMITLESS_CLUSTER_ENDPOINT }}
          TEST_PORT: '5432'
          ODBCINI: "${{ github.workspace }}/test/resources/odbc.ini"
          ODBCINST: "${{ github.workspace }}/test/resources/odbcinst.ini"
      - name: Delete Aurora RDS Cluster
        if: always()
        shell: bash
        run: |
          . "./scripts/aws_rds_helper_unix.sh"
          delete_limitless_db_cluster ${{ env.LIMITLESS_CLUSTER_ID }} ${{ env.LIMITLESS_SHARD_ID }} ${{ secrets.AWS_DEFAULT_REGION }}
      - name: Delete Aurora Db Secrets
        if: always()
        shell: bash
        run: |
          . "./scripts/aws_rds_helper_unix.sh"
          delete_secrets ${{ env.AURORA_CLUSTER_SECRETS_ARN }}
      # Make sure IP is always deleted
      - name: Remove Github Action IP
        if: always()
        shell: bash
        run: |
          . "./scripts/aws_rds_helper_unix.sh"
          remove_ip_from_db_sg \
            ${{ steps.ip.outputs.ipv4 }} \
            ${{ env.LIMITLESS_CLUSTER_ID }} \
            ${{ secrets.AWS_DEFAULT_REGION }}
      # - name: Copy Driver Logs
      #   shell: bash
      #   run: |
      #     cp '${{ runner.temp }}/aws-odbc-wrapper/*.log.*' '${{ github.workspace }}\logs'
      - name: Archive log results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: 'linux-limitless-integration-test-logs'
          path: /tmp/aws-odbc-wrapper/
          retention-days: 3
      - name: Archive psql logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: 'linux-limitless-psql-logs'
          path: logs
          retention-days: 3
