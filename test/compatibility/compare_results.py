#!/usr/bin/env python3

import sys
import os
import json
from deepdiff import DeepDiff

def compare_files(actual_folder, expected_folder):
    """
    The odbc_api_test.cpp executes a list of ODBC API methods using the underlying community driver and the ODBC wrapper.
    The test generates a set of JSON files. This function compares the results generated by the wrapper against the community driver.

    :param actual_folder: path to folder containing JSON files generated by running the tests with the ODBC wrapper.
    :param expected_folder: path to folder containing expected JSON files generated by running the tests with the underlying community driver.
    :return:
    """
    if not os.path.isdir(actual_folder):
        print(f"Error: Actual folder {actual_folder} does not exist.")
        return False
    
    if not os.path.isdir(expected_folder):
        print(f"Error: Expected folder {expected_folder} does not exist.")
        return False
    
    actual_files = {f for f in os.listdir(actual_folder) if f.endswith('.json')}
    expected_files = {f for f in os.listdir(expected_folder) if f.endswith('.json')}
    
    all_files = actual_files | expected_files
    failed_comparisons = []
    
    for filename in sorted(all_files):
        actual_file = os.path.join(actual_folder, filename)
        expected_file = os.path.join(expected_folder, filename)
        
        if filename not in actual_files:
            failed_comparisons.append(f"Missing actual file: {filename}")
            continue
            
        if filename not in expected_files:
            failed_comparisons.append(f"Missing expected file: {filename}")
            continue
        
        try:
            with open(actual_file, 'r') as f:
                actual_json = json.load(f)
            
            with open(expected_file, 'r') as f:
                expected_json = json.load(f)

            diff = DeepDiff(expected_json, actual_json, ignore_order=True)
            if diff:
                failed_comparisons.append(f"Failed - {filename}")
                print(f"\nMismatch in {filename}:")
                print(diff.pretty())
                print("-" * 80)
            else:
                print(f"Ok - {filename}")
                
        except json.JSONDecodeError as e:
            failed_comparisons.append(f"JSON parse error in {filename}: {e}")
            print(f"\nJSON parse error in {filename}: {e}")
        except Exception as e:
            failed_comparisons.append(f"Error comparing {filename}: {e}")
            print(f"\nError comparing {filename}: {e}")
    
    if failed_comparisons:
        print("\nFailed comparisons:")
        for failure in failed_comparisons:
            print(f"  - {failure}")
        return False
    
    print(f"\nAll {len(all_files)} files match successfully.")
    return True

if __name__ == "__main__":
    if len(sys.argv) != 3:
        print("Invalid number of arguments. Usage: python compare_files.py <actual_folder> <expected_folder>")
        sys.exit(1)

    success = compare_files(sys.argv[1], sys.argv[2])
    sys.exit(0 if success else 1)
